<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin | EcoTrack</title>

    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">âš™ï¸</div>
            <h2 class="sidebar-title">Admin</h2>

            <nav>
                <ul class="sidebar-menu">
                    <li>
                        <a href="#" class="ativo">
                            <span class="sidebar-menu-icon">ğŸ“Š</span>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navegarPara('usuarios')">
                            <span class="sidebar-menu-icon">ğŸ‘¥</span>
                            <span>UsuÃ¡rios</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navegarPara('entregas')">
                            <span class="sidebar-menu-icon">ğŸ“¦</span>
                            <span>Entregas</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navegarPara('recompensas')">
                            <span class="sidebar-menu-icon">ğŸ</span>
                            <span>Recompensas</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navegarPara('medalhas')">
                            <span class="sidebar-menu-icon">ğŸ…</span>
                            <span>Medalhas</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navegarPara('relatorios')">
                            <span class="sidebar-menu-icon">ğŸ“ˆ</span>
                            <span>RelatÃ³rios</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navegarPara('configuracoes')">
                            <span class="sidebar-menu-icon">âš™ï¸</span>
                            <span>ConfiguraÃ§Ãµes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="fazerLogout()">
                            <span class="sidebar-menu-icon">ğŸšª</span>
                            <span>Sair</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- ConteÃºdo Principal -->
        <main class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="dashboard-welcome">
                    <h1>Painel Administrativo</h1>
                    <p id="data-atual"></p>
                </div>

                <div class="dashboard-user">
                    <div class="user-avatar" id="user-avatar"></div>
                    <div class="user-info">
                        <h3 id="user-name"></h3>
                        <p id="user-type">Administrador</p>
                    </div>
                </div>
            </header>

            <!-- Cards de EstatÃ­sticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Total de UsuÃ¡rios</p>
                            <h2 class="stat-card-value" id="total-usuarios">0</h2>
                            <p class="stat-card-info">Cadastrados</p>
                        </div>
                        <div class="stat-card-icon roxo">ğŸ‘¥</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Total de Entregas</p>
                            <h2 class="stat-card-value" id="total-entregas">0</h2>
                            <p class="stat-card-info">Todas as entregas</p>
                        </div>
                        <div class="stat-card-icon azul">ğŸ“¦</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Material Reciclado</p>
                            <h2 class="stat-card-value" id="total-kg">0 kg</h2>
                            <p class="stat-card-info">Total geral</p>
                        </div>
                        <div class="stat-card-icon verde">â™»ï¸</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Pendentes</p>
                            <h2 class="stat-card-value" id="total-pendentes">0</h2>
                            <p class="stat-card-info">Aguardando validaÃ§Ã£o</p>
                        </div>
                        <div class="stat-card-icon amarelo">â³</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Recompensas</p>
                            <h2 class="stat-card-value" id="total-recompensas">0</h2>
                            <p class="stat-card-info">DisponÃ­veis</p>
                        </div>
                        <div class="stat-card-icon rosa">ğŸ</div>
                    </div>
                </div>
            </div>

            <!-- AÃ§Ãµes RÃ¡pidas -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">AÃ§Ãµes RÃ¡pidas</h2>
                </div>

                <div class="quick-actions">
                    <div class="quick-action-btn" onclick="navegarPara('novo-usuario')">
                        <div class="quick-action-icon">ğŸ‘¤â•</div>
                        <div class="quick-action-text">Novo UsuÃ¡rio</div>
                    </div>

                    <div class="quick-action-btn" onclick="navegarPara('nova-recompensa')">
                        <div class="quick-action-icon">ğŸâ•</div>
                        <div class="quick-action-text">Nova Recompensa</div>
                    </div>

                    <div class="quick-action-btn" onclick="navegarPara('nova-medalha')">
                        <div class="quick-action-icon">ğŸ…â•</div>
                        <div class="quick-action-text">Nova Medalha</div>
                    </div>

                    <div class="quick-action-btn" onclick="navegarPara('relatorio')">
                        <div class="quick-action-icon">ğŸ“Š</div>
                        <div class="quick-action-text">Gerar RelatÃ³rio</div>
                    </div>
                </div>
            </section>

            <!-- GrÃ¡fico de Entregas -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Entregas por Status</h2>
                </div>

                <div class="chart-container">
                    <p>ğŸ“Š GrÃ¡ficos serÃ£o implementados em breve</p>
                </div>
            </section>

            <!-- UsuÃ¡rios Recentes -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">UsuÃ¡rios Recentes</h2>
                    <a href="#" onclick="navegarPara('usuarios')" class="btn btn-outline btn-small">Ver Todos</a>
                </div>

                <div id="usuarios-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <p>Carregando usuÃ¡rios...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="../../js/api.js"></script>
    <script src="../../js/utils.js"></script>
    <script>
        let usuario = null;

        document.addEventListener('DOMContentLoaded', async function() {
            usuario = verificarAutenticacao();
            if (!usuario || usuario.tipo_usuario !== 'admin') {
                alert('Acesso nÃ£o autorizado');
                fazerLogout();
                return;
            }

            carregarDadosUsuario();
            carregarEstatisticas();
            carregarUsuariosRecentes();
        });

        function carregarDadosUsuario() {
            document.getElementById('user-name').textContent = usuario.nome;
            const inicial = usuario.nome.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = inicial;

            const hoje = new Date();
            document.getElementById('data-atual').textContent = hoje.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        async function carregarEstatisticas() {
            try {
                // Carrega usuÃ¡rios
                const usuarios = await apiGet('/usuarios');
                document.getElementById('total-usuarios').textContent = usuarios.length;

                // Carrega entregas
                const entregas = await apiGet('/entregas');
                document.getElementById('total-entregas').textContent = entregas.length;

                // Calcula total reciclado
                let totalKg = 0;
                entregas.forEach(entrega => {
                    totalKg += entrega.peso_total || 0;
                });
                document.getElementById('total-kg').textContent = formatarNumero(totalKg, 2) + ' kg';

                // Conta pendentes
                const pendentes = entregas.filter(e => e.status === 'pendente');
                document.getElementById('total-pendentes').textContent = pendentes.length;

                // Carrega recompensas
                const recompensas = await apiGet('/recompensas');
                document.getElementById('total-recompensas').textContent = recompensas.length;

            } catch (erro) {
                console.error('Erro ao carregar estatÃ­sticas:', erro);
            }
        }

        async function carregarUsuariosRecentes() {
            try {
                const usuarios = await apiGet('/usuarios');
                const usuariosRecentes = usuarios
                    .sort((a, b) => new Date(b.criado_em) - new Date(a.criado_em))
                    .slice(0, 10);

                const container = document.getElementById('usuarios-container');

                if (usuariosRecentes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <p>Nenhum usuÃ¡rio cadastrado ainda.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th>Cadastro</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${usuariosRecentes.map(u => `
                                <tr>
                                    <td><strong>${u.nome}</strong></td>
                                    <td>${u.email}</td>
                                    <td><span class="badge ${u.tipo_usuario}">${capitalizarPalavras(u.tipo_usuario)}</span></td>
                                    <td>${formatarData(u.criado_em)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (erro) {
                console.error('Erro ao carregar usuÃ¡rios:', erro);
            }
        }

        function navegarPara(pagina) {
            alert(`NavegaÃ§Ã£o para ${pagina} serÃ¡ implementada em breve!`);
        }
    </script>
</body>
</html>
