<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <title>Entregas</title>
    <link rel="stylesheet" href="../css/styles.css"></head>
<body>
    <header>
        <h1>Entregas</h1>
        <nav>
            <a href="index.html">Voltar</a>
        </nav>
    </header>

    <main class="container">
    <form id="form-entrega"><input type="hidden" id="entrega-id">
        <label>Usuário (ID):
            <input id="entrega-usuario" type="number" required>
        </label>
        <label>Notas:
            <textarea id="entrega-notes"></textarea>
        </label>
        <label>Pontos esperados:
            <input id="entrega-pontos-esp" type="number" step="0.01">
        </label>
        <div class="actions">
            <button>Salvar (criar)</button>
            <button type="button" id="reset" class="secondary">Limpar</button>
        </div>
    </form>

    <h2>Lista</h2>
    <table id="tbl-entregas">
        <thead>
            <tr>
                <th>ID</th>
                <th>Usuário</th>
                <th>Status</th>
                <th>Pontos Recebidos</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </main>

    <script src="../js/api.js"></script>
    <script>

        async function carregar() {
            const rows = await apiGet('/entregas');
            const t = document.querySelector('#tbl-entregas tbody');
            t.innerHTML = '';
            rows.forEach(r => {
                t.innerHTML += `
                <tr>
                    <td>${r.ID}</td>
                    <td>${r.usuario_id}</td>
                    <td>${r.status}</td>
                    <td>${r.pontos_recebidos || ''}</td>
                    <td class="actions">
                        <button onclick="editar(${r.ID})" class="small">Editar</button>
                        <button onclick="excluir(${r.ID})" class="small secondary">Excluir</button>
                        <button onclick="validar(${r.ID})" class="small">Validar</button>
                    </td>
                </tr>`
            });
        }

        async function editar(id) {
            const r = await apiGet('/entregas/'+ id);
            document.getElementById('entrega-id').value=r.ID;
            document.getElementById('entrega-usuario').value=r.usuario_id;
            document.getElementById('entrega-notes').value=r.avisos || '';
            document.getElementById('entrega-pontos-esp').value=r.pontos_esperados || '';
        }

        async function excluir(id) {
            if(!confirm('Excluir?')) return;
            await apiDelete('/entregas/'+ id);
            carregar();
        }

        async function validar(id) {
            const pontos = prompt('Insira pontos finais (número):');
            if(pontos===null) return;
            try{
                await apiPut('/entregas/'+ id, {
                    status: 'validado',
                    pontos_recebidos: parseFloat(pontos),
                    validado_por: 1,
                    validado_em: new Date().toISOString()
                });
                carregar();
            }
            catch(e) {
                showError(e);
            }
        }

        document.getElementById('form-entrega').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('entrega-id').value;
            const body = {
                usuario_id: parseInt(document.getElementById('entrega-usuario').value),
                avisos: document.getElementById('entrega-notes').value || null,
                pontos_esperados: parseFloat(document.getElementById('entrega-pontos-esp').value) || null
            };
            if(id) await apiPut('/entregas/'+ id, body);
            else await apiPost('/entregas', body);
            document.getElementById('reset').click();
            carregar();
        });

        document.getElementById('reset').addEventListener('click', () => {
            document.getElementById('form-entrega').reset();
            document.getElementById('entrega-id').value='';
        });

        window.addEventListener('load', carregar);

    </script>
</body>
</html>
